#!/bin/ash

# This script synchronizes the source to target directories 
# to provide a copy for the duplicity script to run to encrypt the backup 
# and push to the backup to destination and offsite.
 
/usr/bin/rsync --exclude 'duplicity' --recursive --verbose $HOME/source/ $HOME/local

# duplicity full --encrypt-key <key-id> /var/backup file:///opt/backup
TARGET_URL=file://$HOME/target

SUNDAY="0"
DAY_OF_WEEK="$(/bin/date +%u)"
if [ $DAY_OF_WEEK == $SUNDAY ] ; then
 PASSPHRASE=$DUPLICITY_ENCRYPTER_PASSWORD duplicity cleanup --force file://$HOME/target
 /usr/bin/duplicity remove-older-than 1W --force
 PASSPHRASE=$DUPLICITY_ENCRYPTER_PASSWORD SIGN_PASSPHRASE=$DUPLICITY_SIGNER_PASSWORD /usr/bin/duplicity full --archive-dir $HOME/cache --encrypt-key $DUPLICITY_ENCRYPTER_FINGERPRINT --sign-key $DUPLICITY_SIGNER_FINGERPRINT --verbosity d $HOME/local $TARGET_URL
else
 PASSPHRASE=$DUPLICITY_ENCRYPTER_PASSWORD SIGN_PASSPHRASE=$DUPLICITY_SIGNER_PASSWORD /usr/bin/duplicity --archive-dir $HOME/cache --encrypt-key $DUPLICITY_ENCRYPTER_FINGERPRINT --sign-key $DUPLICITY_SIGNER_FINGERPRINT --verbosity d $HOME/local $TARGET_URL
 echo "COMPLETE SIGNAL $?"
fi
