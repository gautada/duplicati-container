#!/bin/ash

# This script synchronizes the source to target directories 
# to provide a copy for the duplicity script to run to encrypt the backup 
# and push to the backup to destination and offsite.
 
/usr/bin/rsync --recursive --exclude 'duplicity' $HOME/source/ $HOME/local

# duplicity full --encrypt-key <key-id> /var/backup file:///opt/backup
TARGET_URL=file://$HOME/target

/usr/bin/duplicity remove-older-than 1W --force
 
PASSPHRASE=$DUPLICITY_ENCRYPTER_PASSWORD SIGN_PASSPHRASE=$DUPLICITY_SIGNER_PASSWORD /usr/bin/duplicity --verbosity d --encrypt-key $DUPLICITY_ENCRYPTER_FINGERPRINT --sign-key $DUPLICITY_SIGNER_FINGERPRINT --archive-dir $HOME/cache $HOME/local $TARGET_URL

echo $?

# date +%u